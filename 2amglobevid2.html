<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Random Globe - Clean</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:transparent}
    body{
      font-family:"Courier New","Lucida Console",monospace;
      color:#CFCFCF; overflow:hidden;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      position: relative;
    }
    #background-container {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
      overflow: hidden;
      background: #ffffff;
    }
    #videoBg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      border: none;
      z-index: 1;
      opacity: 1;
      transition: opacity 0.3s;
    }
    #videoBg.hidden {
      opacity: 0;
      z-index: -1;
    }
    #stage{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index: 1;}
    #map{
      white-space:pre; line-height:1; letter-spacing:0; user-select:text;
      font-kerning:none; font-variant-ligatures:none; font-feature-settings:"liga" 0,"calt" 0;
      word-spacing:0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="background-container">
    <iframe id="videoBg"></iframe>
  </div>
  <div id="stage">
    <div id="map" aria-label="Random ASCII globe"></div>
  </div>
  <audio id="radio-player"></audio>

  <script>
  const DEG = Math.PI/180;
  const rad = d=>d*DEG;
  const normLon = lon => ((lon + 180) % 360 + 360) % 360 - 180;

  function randomFloat(min, max) { return Math.random() * (max - min) + min; }
  function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
  function randomChoice(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
  function randomHexColor() { return '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0'); }

  const OCEAN_CHAR_SETS = [
    ['.', '~', '≈', '∼', '·', '○', '◦'],
    ['o', '0', '@', '*', '•', '°', '∘'],
    ['~', '≈', '∿', '≋', '∼', '≊', '⊗'],
    [',', ';', ':', '·', '.', '…', '˙'],
    ['▫', '▪', '■', '□', '▢', '▬', '▭']
  ];
  
  const COAST_CHAR_SETS = [
    ['*', '#', '@', '&', '%', '▓', '█', '▪', '■'],
    ['#', '*', '&', '%', '@', '▓', '█', '▬', '▮'],
    ['@', '#', '&', '*', '%', '▓', '▓', '▫', '█'],
    ['+', 'X', 'x', '*', '#', '▓', '█', '▪', '▫'],
    ['%', '&', '@', '#', '*', '▓', '█', '▬', '▮']
  ];
  
  const FILL_CHAR_SETS = [
    ['=', '-', '+', '░', '▒', '▓', '█', ':', ';', '|'],
    ['-', '=', '+', '░', '▒', '▓', '█', '|', ':', ';'],
    ['█', '▓', '▒', '░', '+', '=', '-', '|', ':', ';'],
    [':', ';', '|', '+', '=', '-', '░', '▒', '▓', '█'],
    ['|', ':', ';', '░', '▒', '▓', '█', '=', '-', '+']
  ];
  
  const GRID_CHAR_SETS = [
    ['.', ':', '+', '·', '×', '▫', '▪'],
    ['+', '.', ':', '·', '×', '▫', '▪'],
    ['·', '×', '▫', '▪', '.', ':', '+'],
    ['×', '·', '▪', '▫', '+', '.', ':'],
    ['.', '+', '·', '×', ':', '▫', '▪']
  ];
  
  const LINE_CHAR_SETS = [
    ['=', '-', '―', '━', '═', '▬'],
    ['-', '=', '―', '━', '═', '▬'],
    ['━', '═', '▬', '―', '=', '-'],
    ['▬', '━', '═', '―', '-', '='],
    ['―', '━', '═', '▬', '-', '=']
  ];

  const COLOR_SCHEMES = [
    { name: "Ocean Blue", ocean: "#1e3a5f", coast: "#d4af37", land1: "#228b22", land2: "#32cd32" },
    { name: "Desert", ocean: "#4682b4", coast: "#daa520", land1: "#deb887", land2: "#f4a460" },
    { name: "Arctic", ocean: "#191970", coast: "#87ceeb", land1: "#f0f8ff", land2: "#e0e0e0" },
    { name: "Tropical", ocean: "#006994", coast: "#ff7f50", land1: "#228b22", land2: "#90ee90" },
    { name: "Volcanic", ocean: "#2f4f4f", coast: "#ff4500", land1: "#8b4513", land2: "#a0522d" },
    { name: "Cyberpunk", ocean: "#0f0f23", coast: "#ff00ff", land1: "#00ffff", land2: "#ffff00" },
    { name: "Monochrome", ocean: "#333333", coast: "#cccccc", land1: "#666666", land2: "#999999" },
    { name: "Retro", ocean: "#000080", coast: "#ffa500", land1: "#800080", land2: "#ff69b4" }
  ];

  function generateRandomPalette() {
    const scheme = randomChoice(COLOR_SCHEMES);
    return {
      name: scheme.name,
      oceanChar: randomChoice(OCEAN_CHAR_SETS[0]),
      coastChar: randomChoice(COAST_CHAR_SETS[0]),
      fillAChar: randomChoice(FILL_CHAR_SETS[0]),
      fillBChar: randomChoice(FILL_CHAR_SETS[0]),
      gridChar: randomChoice(GRID_CHAR_SETS[0]),
      equatorChar: randomChoice(LINE_CHAR_SETS[0]),
      primeChar: randomChoice(LINE_CHAR_SETS[0]),
      rimChar: randomChoice(['.', ':', '·', '○']),
      vignChar: randomChoice(['.', ':', '·', '▫']),
      colOcean: scheme.ocean,
      colCoast: scheme.coast,
      colFillA: scheme.land1,
      colFillB: scheme.land2,
      colGrid: randomHexColor(),
      colEquator: randomHexColor(),
      colPrime: randomHexColor(),
      colRim: randomHexColor(),
      colVign: randomHexColor(),
      col2AM: "#ff0088"
    };
  }

  function get2AMLongitude() {
    const now = new Date();
    const utc = now.getUTCHours() + now.getUTCMinutes()/60;
    let hoursFromUTC = 2 - utc;
    if (hoursFromUTC < -12) hoursFromUTC += 24;
    if (hoursFromUTC > 12)  hoursFromUTC -= 24;
    return normLon(hoursFromUTC * 15);
  }

  const videoStreams = {
    "-12": "https://www.youtube.com/embed/DIgkvm2nmHc?autoplay=1&mute=1&controls=0&loop=1&playlist=DIgkvm2nmHc&vq=hd1080",
    "-11": "https://www.youtube.com/embed/yf5cEJULZXk?autoplay=1&mute=1&controls=0&loop=1&playlist=yf5cEJULZXk&vq=hd1080",
    "-10": "https://www.youtube.com/embed/og8bbxl0iW8?autoplay=1&mute=1&controls=0&loop=1&playlist=og8bbxl0iW8&vq=hd1080",
    "-9": "https://www.youtube.com/embed/h378-aAa224?autoplay=1&mute=1&controls=0&loop=1&playlist=h378-aAa224,VI8Wj5EwoRM&vq=hd1080",
    "-8": "https://www.youtube.com/embed/73-EekdVVU8?autoplay=1&mute=1&controls=0&loop=1&playlist=73-EekdVVU8&vq=hd1080",
    "-7": "https://www.youtube.com/embed/3LXQWU67Ufk?autoplay=1&mute=1&controls=0&loop=1&playlist=3LXQWU67Ufk&vq=hd1080",
    "-6": "https://www.youtube.com/embed/z9JpMNJYuYg?autoplay=1&mute=1&controls=0&loop=1&playlist=z9JpMNJYuYg&vq=hd1080",
    "-5": "https://www.youtube.com/embed/XCMRy1oxDpc?autoplay=1&mute=1&controls=0&loop=1&playlist=XCMRy1oxDpc,Fjhb4nhL73o,uaI9_RZjT3Y&vq=hd1080",
    "-4": "https://www.youtube.com/embed/fIMbMz2P7Bs?autoplay=1&mute=1&controls=0&loop=1&playlist=fIMbMz2P7Bs&vq=hd1080",
    "-3": "https://www.youtube.com/embed/6QoLEltTzIM?autoplay=1&mute=1&controls=0&loop=1&playlist=6QoLEltTzIM&vq=hd1080",
    "-2": "https://www.youtube.com/embed/N78L9u89Fvc?autoplay=1&mute=1&controls=0&loop=1&playlist=N78L9u89Fvc&vq=hd1080",
    "-1": "https://www.youtube.com/embed/3QS0NMMgDNY?autoplay=1&mute=1&controls=0&loop=1&playlist=3QS0NMMgDNY&vq=hd1080",
    "0": "https://www.youtube.com/embed/yuIm1V7Ne7I?autoplay=1&mute=1&controls=0&vq=hd1080",
    "1": "https://www.youtube.com/embed/u4UZ4UvZXrg?autoplay=1&mute=1&controls=0&loop=1&playlist=u4UZ4UvZXrg&vq=hd1080",
    "2": "https://www.youtube.com/embed/a37ZDRECzIA?autoplay=1&mute=1&controls=0&loop=1&playlist=a37ZDRECzIA&vq=hd1080",
    "3": "https://www.youtube.com/embed/e2gC37ILQmk?autoplay=1&mute=1&controls=0&loop=1&playlist=e2gC37ILQmk&vq=hd1080",
    "4": "https://www.youtube.com/embed/7mnbtXqdmr0?autoplay=1&mute=1&controls=0&loop=1&playlist=7mnbtXqdmr0&vq=hd1080",
    "5": "https://www.youtube.com/embed/YsVog8149q8?autoplay=1&mute=1&controls=0&loop=1&playlist=YsVog8149q8&vq=hd1080",
    "6": "https://www.youtube.com/embed/YsVog8149q8?autoplay=1&mute=1&controls=0&loop=1&playlist=YsVog8149q8&vq=hd1080",
    "7": "https://www.youtube.com/embed/p0Qhe4vhYLQ?autoplay=1&mute=1&controls=0&loop=1&playlist=p0Qhe4vhYLQ&vq=hd1080",
    "8": "https://www.youtube.com/embed/3szkFHfr6sA?autoplay=1&mute=1&controls=0&loop=1&playlist=3szkFHfr6sA&vq=hd1080",
    "9": "https://www.youtube.com/embed/DjdUEyjx8GM?autoplay=1&mute=1&controls=0&vq=hd1080",
    "10": "https://www.youtube.com/embed/5uZa3-RMFos?autoplay=1&mute=1&controls=0&vq=hd1080",
    "11": "https://www.youtube.com/embed/yf5cEJULZXk?autoplay=1&mute=1&controls=0&loop=1&playlist=yf5cEJULZXk&vq=hd1080"
  };

  const audioStreams = {
    "-12": "https://worldwidefm.out.airtime.pro/worldwidefm_b",
    "-11": "https://worldwidefm.out.airtime.pro/worldwidefm_b",
    "-10": "https://orbit.citrus3.com:2020/stream/divineradiolondon",
    "-9": "https://stream.ktuh.org:8001/stream",
    "-8": "https://s26.myradiostream.com:17824/;?type=http&nocache=1742989445",
    "-7": "https://dublab.out.airtime.pro/dublab_a",
    "-6": "https://radio.mensajito.mx/nopalVentana",
    "-5": "https://edge.mixlr.com/channel/ibrdq",
    "-4": "https://n10as.radiocult.fm/stream",
    "-3": "https://servidor24-1.brlogic.com:7516/live",
    "-2": "http://ice-11.spilarinn.is/fmxtra",
    "-1": "https://stream.radioquantica.com:8443/stream",
    "0": "https://oroko-radio.radiocult.fm/stream",
    "1": "https://s107.radiolize.com:8000/radio.mp3",
    "2": "https://cashmereradio.out.airtime.pro/cashmereradio_b",
    "3": "https://20ft-radio.radiocult.fm/stream",
    "4": "https://n09.radiojar.com/78cxy6wkxtzuv?1742491576=&rj-ttl=5&rj-tok=AAABlmp-uzoAGwSgsdWpww34qA",
    "5": "https://www.muso.fm/api/proxy-stream?url=http%3A%2F%2F94.130.113.214%3A8000%2Fdubtechno",
    "6": "https://www.muso.fm/api/proxy-stream?url=http%3A%2F%2F94.130.113.214%3A8000%2Fschizoid",
    "7": "https://stream.zeno.fm/2uhuu5hvzqzuv",
    "8": "https://listen.belowground.fm/listen/belowground_fm/radio.mp3",
    "9": "https://uk5.internet-radio.com/proxy/mmr?mp=/stream",
    "10": "https://radio.beshknow.com/beshknow",
    "11": "https://stream.tbc.radio:8000/radio.mp3",
    "12": "https://radio.kamchatkalive.ru:8103/dance"
  };

  class RandomGlobe {
    constructor(){
      this.width = 128;
      this.height = 64;
      this.centerX = this.width/2;
      this.centerY = this.height/2;
      this.radius = 25;
      this.luminanceRamp = " .'`^\",:;Il!i><~+_-?][}{1)(|\\/*tfrxnvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$";
      this.host = document.getElementById("map");
      this.videoKeys = Object.keys(videoStreams);
      this.currentVideoIndex = 0;
      this.voidColor = "#ffffff";
      this.showVideo = true;
      this.oceanCharSetIndex = 0;
      this.coastCharSetIndex = 0;
      this.fillCharSetIndex = 0;
      this.gridCharSetIndex = 0;
      this.lineCharSetIndex = 0;
      
      this.randomizeSettings();
      this.ensureSpinning();
      this.show2AM = true;
      this.initDetailedWorldData();
      this.recalcFontSize();
      this.bind();
      document.body.style.background = "#ffffff";
      document.getElementById("videoBg").classList.add("hidden");
      this.render();
      this.loop();
    }

    randomizeSettings() {
      this.longitude = randomFloat(-180, 180);
      this.centerLat = randomFloat(-60, 60);
      this.useLighting = Math.random() > 0.2;
      this.spin = Math.random() > 0.3;
      this.gridOver = Math.random() > 0.5;
      this.showEquator = Math.random() > 0.6;
      this.showPrime = Math.random() > 0.6;
      this.show2AM = true;
      this.cellAR = randomFloat(1.5, 2.5);
      this.roundMode = randomChoice(["auto", "off", "manual"]);
      this.roundManual = randomFloat(1.8, 2.2);
      this.pal = generateRandomPalette();
      this.spinSpeed = randomFloat(0.3, 0.8);
    }

    ensureSpinning() {
      let attempts = 0;
      while (!this.spin && attempts < 10) {
        this.randomizeSettings();
        attempts++;
      }
      if (!this.spin) {
        this.spin = true;
        this.spinSpeed = randomFloat(0.3, 0.8);
      }
    }

    bind(){
      const keyMap = {
        'q': () => { this.oceanCharSetIndex = (this.oceanCharSetIndex + 1) % OCEAN_CHAR_SETS.length; this.pal.oceanChar = randomChoice(OCEAN_CHAR_SETS[this.oceanCharSetIndex]); this.render(); },
        'w': () => { this.coastCharSetIndex = (this.coastCharSetIndex + 1) % COAST_CHAR_SETS.length; this.pal.coastChar = randomChoice(COAST_CHAR_SETS[this.coastCharSetIndex]); this.render(); },
        'e': () => { this.fillCharSetIndex = (this.fillCharSetIndex + 1) % FILL_CHAR_SETS.length; this.pal.fillAChar = randomChoice(FILL_CHAR_SETS[this.fillCharSetIndex]); this.pal.fillBChar = randomChoice(FILL_CHAR_SETS[this.fillCharSetIndex]); this.render(); },
        'r': () => { this.gridCharSetIndex = (this.gridCharSetIndex + 1) % GRID_CHAR_SETS.length; this.pal.gridChar = randomChoice(GRID_CHAR_SETS[this.gridCharSetIndex]); this.render(); },
        't': () => { this.lineCharSetIndex = (this.lineCharSetIndex + 1) % LINE_CHAR_SETS.length; this.pal.equatorChar = randomChoice(LINE_CHAR_SETS[this.lineCharSetIndex]); this.pal.primeChar = randomChoice(LINE_CHAR_SETS[this.lineCharSetIndex]); this.render(); },
        'y': () => { this.pal = generateRandomPalette(); this.render(); },
        'u': () => { this.spin = !this.spin; },
        'i': () => { this.useLighting = !this.useLighting; this.render(); },
        'o': () => { this.showEquator = !this.showEquator; this.render(); },
        'p': () => { this.showPrime = !this.showPrime; this.render(); },
        'å': () => { this.show2AM = !this.show2AM; this.render(); },
        'a': () => { this.centerLat = (this.centerLat + 15) % 90; this.render(); },
        's': () => { this.centerLat = (this.centerLat - 15) % 90; this.render(); },
        'd': () => { this.spinSpeed = Math.max(0.1, this.spinSpeed - 0.1); },
        'f': () => { this.spinSpeed = Math.min(2, this.spinSpeed + 0.1); },
        'g': () => { this.gridOver = !this.gridOver; this.render(); },
        'h': () => { this.pal.rimChar = randomChoice(['.', ':', '·', '○', '*', '#']); this.render(); },
        'j': () => { this.radius = Math.max(15, this.radius - 2); this.render(); },
        'k': () => { this.radius = this.radius + 2; this.render(); },
        'l': () => { this.voidColor = randomHexColor(); document.getElementById("background-container").style.background = this.voidColor; this.render(); },
        'z': () => { this.pal.colOcean = randomHexColor(); this.render(); },
        'x': () => { this.pal.colCoast = randomHexColor(); this.render(); },
        'c': () => { this.pal.colFillA = randomHexColor(); this.render(); },
        'v': () => { this.pal.colFillB = randomHexColor(); this.render(); },
        'b': () => { this.pal.colGrid = randomHexColor(); this.render(); },
        'n': () => { this.pal.colEquator = randomHexColor(); this.render(); },
        'm': () => { this.pal.colPrime = randomHexColor(); this.render(); },
        ',': () => { this.pal.colRim = randomHexColor(); this.render(); },
        '.': () => { this.pal.colVign = randomHexColor(); this.render(); },
        '/': () => { this.pal.col2AM = randomHexColor(); this.render(); },
        '1': () => { this.currentVideoIndex = (this.currentVideoIndex + 1) % this.videoKeys.length; this.updateBackground(this.videoKeys[this.currentVideoIndex]); this.showVideo = true; document.getElementById("videoBg").classList.remove("hidden"); },
        '2': () => { this.longitude = (this.longitude + 30) % 360; this.render(); },
        '3': () => { this.longitude = (this.longitude - 30) % 360; this.render(); },
        '4': () => { this.roundMode = this.roundMode === "auto" ? "off" : this.roundMode === "off" ? "manual" : "auto"; this.render(); },
        '5': () => { this.centerLat = randomFloat(-60, 60); this.render(); },
        '6': () => { this.longitude = randomFloat(-180, 180); this.render(); },
        '7': () => { this.randomizeSettings(); this.render(); },
        '8': () => { this.pal.col2AM = randomHexColor(); this.render(); },
        '9': () => { this.pal.colRim = randomHexColor(); this.render(); },
        '0': () => { this.pal.colVign = randomHexColor(); this.render(); },
        '-': () => { this.pal.colOcean = randomHexColor(); this.pal.colCoast = randomHexColor(); this.render(); },
        '=': () => { this.pal.colFillA = randomHexColor(); this.pal.colFillB = randomHexColor(); this.render(); },
        '[': () => { this.pal.colGrid = randomHexColor(); this.pal.colEquator = randomHexColor(); this.pal.colPrime = randomHexColor(); this.render(); },
        ']': () => { this.pal.col2AM = randomHexColor(); this.pal.colRim = randomHexColor(); this.pal.colVign = randomHexColor(); this.render(); }
      };

      window.addEventListener("keydown", (e) => {
        const key = e.key.toLowerCase();
        if (keyMap[key]) {
          e.preventDefault();
          keyMap[key]();
        } else if (e.key === " ") {
          e.preventDefault();
          const now = new Date();
          const utc = now.getUTCHours() + now.getUTCMinutes()/60;
          let offset = 2 - utc;
          while (offset < -12) offset += 24;
          while (offset > 12) offset -= 24;
          const audio = document.getElementById("radio-player");
          audio.src = audioStreams[String(Math.round(offset))];
          audio.play().catch(()=>{});
        }
      });

      window.addEventListener("resize", ()=>{
        this.recalcFontSize();
        this.render();
      });
    }

    updateBackground(key){
      const bgFrame = document.getElementById("videoBg");
      const url = videoStreams[key];
      bgFrame.src = url;
    }

    measureCell(){
      const s=document.createElement("span");
      s.textContent="M";
      s.style.position="absolute"; s.style.visibility="hidden";
      s.style.fontFamily="'Courier New',monospace";
      s.style.lineHeight="1"; s.style.letterSpacing="0";
      document.body.appendChild(s);
      const r=s.getBoundingClientRect(); s.remove();
      return {cw:r.width, ch:r.height};
    }

    recalcFontSize(){
      const targetW = window.innerWidth - 16;
      const targetH = window.innerHeight - 16;
      let lo=6, hi=72, best=12;
      while(lo<=hi){
        const mid = Math.floor((lo+hi)/2);
        this.host.style.fontSize = mid+"px";
        const cell = this.measureCell();
        const ok = (this.width*cell.cw <= targetW) && (this.height*cell.ch <= targetH);
        if(ok){ best=mid; lo=mid+1; } else { hi=mid-1; }
      }
      this.host.style.fontSize = best+"px";
      const cell = this.measureCell();
      this.cellAR = cell.ch / cell.cw;
    }

    loop(){
      this.animationId = setInterval(()=>{
        if(this.spin){
          this.longitude = (this.longitude + this.spinSpeed) % 360;
          this.render();
        }
      }, 60);
    }

    initDetailedWorldData(){
      this.continents = {
        northAmerica: [[71,-156],[70,-140],[69,-133],[65,-135],[60,-135],[58,-94],[60,-64],[58,-62],[55,-57],[50,-56],[47,-58],[45,-60],[44,-67],[42,-68],[41,-70],[40,-72],[39,-74],[37,-75],[36,-76],[34,-78],[32,-81],[30,-81],[28,-82],[25,-80],[24,-81],[26,-82],[28,-84],[29,-85],[29,-87],[29,-90],[29,-94],[28,-95],[26,-97],[25,-98],[23,-106],[22,-105],[20,-105],[18,-103],[16,-95],[15,-93],[14,-92],[16,-87],[19,-96],[23,-110],[26,-112],[32,-117],[34,-118],[37,-122],[40,-124],[42,-124],[45,-124]],
        southAmerica: [[12,-71],[11,-68],[11,-60],[8,-58],[5,-51],[3,-48],[2,-44],[0,-42],[-3,-38],[-5,-36],[-8,-35],[-12,-37],[-16,-39],[-20,-40],[-23,-43],[-26,-48],[-30,-50],[-34,-52],[-38,-58],[-42,-62],[-46,-65],[-50,-67],[-55,-68],[-54,-70],[-52,-75],[-48,-74],[-40,-73],[-33,-71],[-25,-70],[-18,-70],[-10,-75],[-5,-78],[-1,-81],[1,-84],[3,-87],[5,-85],[8,-77],[10,-74]],
        europe: [[71,25],[70,28],[70,31],[68,30],[66,24],[64,20],[60,11],[58,8],[55,6],[51,3],[48,2],[45,-2],[43,-9],[41,-8],[38,-7],[36,-6],[38,-1],[40,0],[43,3],[45,5],[46,7],[47,12],[45,20],[46,25],[47,30],[48,35],[50,38],[52,40],[55,40],[58,38],[62,35],[65,32],[68,33]],
        africa: [[37,-6],[35,-5],[33,0],[32,10],[32,20],[32,32],[31,34],[28,38],[22,40],[15,42],[12,45],[12,51],[8,50],[0,45],[-5,42],[-12,40],[-18,38],[-22,35],[-26,33],[-30,28],[-33,25],[-35,20],[-34,18],[-33,18],[-28,15],[-20,12],[-15,12],[-8,8],[0,5],[5,3],[10,0],[15,-17],[18,-16],[21,-17],[25,-15],[30,-10],[35,-8]],
        asia: [[77,104],[75,120],[73,140],[70,160],[69,180],[66,-170],[62,-165],[60,-165],[58,-160],[55,-155],[50,140],[48,135],[45,132],[42,130],[38,128],[35,129],[32,125],[28,122],[24,121],[20,118],[18,109],[15,105],[10,103],[5,102],[1,104],[-5,110],[-8,115],[-6,120],[2,125],[8,120],[12,115],[15,105],[10,95],[8,77],[15,72],[20,70],[23,69],[28,70],[32,72],[37,75],[40,78],[42,80],[45,78],[50,75],[55,73],[60,70],[65,65],[68,50],[70,40],[68,33]],
        australia: [[-10,142],[-11,143],[-12,143],[-15,145],[-20,149],[-24,153],[-28,153],[-32,152],[-35,150],[-37,148],[-39,146],[-38,143],[-37,140],[-35,137],[-33,135],[-30,133],[-26,130],[-22,114],[-20,116],[-18,122],[-15,128],[-12,130],[-11,135],[-10,140]],
        greenland: [[83,-35],[83,-20],[82,-15],[80,-12],[78,-10],[75,-15],[70,-22],[65,-35],[60,-43],[60,-40],[62,-35],[65,-30],[70,-25],[75,-20],[80,-25],[82,-30]],
        madagascar: [[-12,49],[-12,50],[-15,50],[-20,49],[-25,47],[-26,47],[-25,45],[-15,45]],
        newZealandNorth: [[-34,172],[-35,175],[-37,175],[-38,174],[-37,173],[-35,172]],
        newZealandSouth: [[-40,170],[-42,171],[-46,168],[-47,167],[-45,166],[-42,168]],
        japan: [[45,142],[43,144],[40,140],[35,136],[33,130],[35,132],[38,135],[42,140]],
        britain: [[59,-3],[57,-2],[55,-1],[51,1],[50,-1],[50,-5],[52,-5],[55,-4],[58,-4]]
      };
    }

    render(){
      const W=this.width,H=this.height;
      const cx=this.centerX, cy=this.centerY;
      const ar = (this.roundMode==="off") ? 1.0 : (this.roundMode==="manual" ? this.roundManual : this.cellAR);
      this.radius = Math.floor(Math.min(W, H*ar)/2) - 2;
      if(this.radius<15) this.radius=15;
      const R=this.radius;

      const buf = Array.from({length:H},()=>Array(W).fill(' '));
      const typ = Array.from({length:H},()=>Array(W).fill('ocean'));

      for(let y=0;y<H;y++){
        for(let x=0;x<W;x++){
          const dx = x - cx;
          const dy = y - cy;
          const dist = Math.hypot(dx, dy * ar);
          if(dist>R){ buf[y][x]=' '; typ[y][x]='void'; continue; }

          const edgeFactor = 1 - (dist/R);
          const edgeBlend = Math.pow(edgeFactor, 0.3);

          const sx = dx/R;
          const sy = -(dy * ar)/R;
          const z2 = 1 - sx*sx - sy*sy;
          if(z2<0){ buf[y][x]=' '; typ[y][x]='void'; continue; }
          const sz = Math.sqrt(z2);

          const lat = Math.asin(sy)*180/Math.PI + this.centerLat;
          const lon = normLon(Math.atan2(sx, sz)*180/Math.PI + this.longitude);

          const isLand = this.isPointOnLandEnhanced(lat, lon);
          typ[y][x] = isLand ? 'land' : 'ocean';

          let L;
          if(!isLand){
            const oceanDepth = 0.1 + 0.2 * ( Math.sin(lat*0.05)*Math.cos(lon*0.03) + Math.sin(lat*0.1)*Math.sin(lon*0.07) );
            L = Math.max(0, Math.min(0.3, oceanDepth));
          }else{
            const terrain = 0.4 + 0.4 * ( Math.sin(lat*0.1)*Math.cos(lon*0.08) + Math.sin(lat*0.15)*Math.sin(lon*0.12) );
            L = Math.max(0.3, Math.min(0.9, terrain));
          }

          if(this.useLighting){
            const lx=-0.4, ly=0.6, lz=0.7, Li=0.8;
            const dot = sx*lx + sy*ly + sz*lz;
            const light = Math.max(0.2, Math.min(1.0, 0.5 + dot*Li));
            L *= light;
          }

          L *= edgeBlend;
          buf[y][x] = this.lumToChar(L);
        }
      }

      for(let y=1;y<H-1;y++){
        for(let x=1;x<W-1;x++){
          if(typ[y][x]==='land'){
            if(typ[y-1][x]!=='land' || typ[y+1][x]!=='land' || typ[y][x-1]!=='land' || typ[y][x+1]!=='land'){
              typ[y][x]='coast';
            }
          }
        }
      }

      const html = this.paint(buf, typ, ar, R);
      this.host.innerHTML = html;
    }

    project(lat, lon, ar){
      const R=this.radius, cx=this.centerX, cy=this.centerY;
      const dλ = rad(normLon(lon - this.longitude));
      const φ0 = rad(this.centerLat);
      const φ = rad(lat + this.centerLat);
      const cosc = Math.sin(φ0)*Math.sin(φ) + Math.cos(φ0)*Math.cos(φ)*Math.cos(dλ);
      if(cosc<0) return null;
      const x = Math.cos(φ)*Math.sin(dλ);
      const y = Math.cos(φ0)*Math.sin(φ) - Math.sin(φ0)*Math.cos(φ)*Math.cos(dλ);
      return {x: Math.round(cx + x*R), y: Math.round(cy - (y*R)/ar)};
    }

    paint(buf, typ, ar, R){
      const P=this.pal;
      const W=this.width,H=this.height;
      const cx=this.centerX, cy=this.centerY;

      const baseColor = (t, x,y)=>{
        if(t==='coast') return P.colCoast;
        if(t==='land'){
          let coast=9;
          for(let yy=-2;yy<=2;yy++) for(let xx=-2;xx<=2;xx++){
            const ny=y+yy,nx=x+xx;
            if(ny>=0&&ny<H&&nx>=0&&nx<W && typ[ny][nx]==='coast'){
              const m=Math.abs(xx)+Math.abs(yy); if(m<coast) coast=m;
            }
          }
          if(coast>=3){
            return ( (y%2===0 && (x+Math.floor(this.longitude/10))%3===0) ? P.colFillA : P.colFillB );
          }else{
            return P.colFillB;
          }
        }
        if(t==='ocean') return P.colOcean;
        return "#000000";
      };

      const under = Array.from({length:H},()=>Array(W).fill(null));
      const over  = Array.from({length:H},()=>Array(W).fill(null));

      const dash = (x0,y0,x1,y1,setter)=>{
        let dx=Math.abs(x1-x0), sx=x0<x1?1:-1;
        let dy=-Math.abs(y1-y0), sy=y0<y1?1:-1;
        let err=dx+dy, step=0;
        while(true){
          const d=Math.hypot((x0-cx), (y0-cy)*ar);
          if(d<=R && step%4<2 && x0>=0&&x0<W&&y0>=0&&y0<H) setter(x0,y0);
          if(x0===x1 && y0===y1) break;
          const e2=2*err;
          if(e2>=dy){ err+=dy; x0+=sx; }
          if(e2<=dx){ err+=dx; y0+=sy; }
          step++;
        }
      };

      // Grid lines
      for(let φ=-80; φ<=80; φ+=10){
        if(Math.abs(φ)<1) continue;
        let prev=null;
        for(let λ=-180; λ<=180; λ+=1){
          const p=this.project(φ,λ,ar); if(!p){prev=null; continue;}
          if(prev){
            dash(prev.x,prev.y,p.x,p.y,(x,y)=>{
              (this.gridOver?over:under)[y][x]={ch:P.gridChar, color:P.colGrid};
            });
          }
          prev=p;
        }
      }
      for(let λ=-180; λ<=180; λ+=15){
        if(Math.abs(normLon(λ - this.longitude))<1) continue;
        let prev=null;
        for(let φ=-90; φ<=90; φ+=1){
          const p=this.project(φ,λ,ar); if(!p){prev=null; continue;}
          if(prev){
            dash(prev.x,prev.y,p.x,p.y,(x,y)=>{
              (this.gridOver?over:under)[y][x]={ch:P.gridChar, color:P.colGrid};
            });
          }
          prev=p;
        }
      }

      // Equator
      if(this.showEquator){
        for(let λ=-180; λ<=180; λ+=1){
          const p=this.project(0,λ,ar); if(!p) continue;
          if(p.y>=0&&p.y<H&&p.x>=0&&p.x<W) over[p.y][p.x]={ch:P.equatorChar, color:P.colEquator};
          if(p.y+1<H) over[p.y+1][p.x]={ch:P.equatorChar, color:P.colEquator};
        }
      }

      // Prime meridian
      if(this.showPrime){
        for(let φ=-90; φ<=90; φ+=1){
          const p=this.project(φ,this.longitude,ar); if(!p) continue;
          if(p.y>=0&&p.y<H&&p.x>=0&&p.x<W) over[p.y][p.x]={ch:P.primeChar, color:P.colPrime};
          if(p.x+1<W) over[p.y][p.x+1]={ch:P.primeChar, color:P.colPrime};
        }
      }

      // 2AM longitude line (always shown)
      if(this.show2AM){
        const am2Longitude = get2AMLongitude();
        for(let φ=-90; φ<=90; φ+=1){
          const p=this.project(φ, am2Longitude, ar); if(!p) continue;
          if(p.y>=0&&p.y<H&&p.x>=0&&p.x<W) {
            over[p.y][p.x]={ch:'|', color:P.col2AM};
          }
          if(p.x+1<W && p.y>=0&&p.y<H) {
            over[p.y][p.x+1]={ch:'|', color:P.col2AM};
          }
        }
      }

      // Rim + vignette
      for(let y=0;y<H;y++){
        for(let x=0;x<W;x++){
          const d=Math.hypot((x-cx),(y-cy)*ar);
          if(d>R && d<=R+1) over[y][x]={ch:P.rimChar, color:P.colRim};
          else if(d>R+1 && d<=R+2 && ((x+y)%3===0)) over[y][x]={ch:P.rimChar, color:P.colRim};
          const edge = 1 - Math.min(1, d/R);
          if(edge<0.12 && typ[y][x]!=='void'){
            if(!over[y][x]) over[y][x]={ch:P.vignChar, color:P.colVign};
          }
        }
      }

      let html='';
      for(let y=0;y<H;y++){
        for(let x=0;x<W;x++){
          const dx = x - cx;
          const dy = y - cy;
          const dist = Math.hypot(dx, dy * ar);
          const isOutside = dist > R;
          
          const baseCh = buf[y][x];
          const baseT  = typ[y][x];
          const underLay = under[y][x];
          const overLay  = over[y][x];
          let ch = baseCh;
          let color = baseColor(baseT,x,y);
          let bgColor = '';
          if(underLay){ ch = underLay.ch; color = underLay.color; }
          if(overLay){ ch = overLay.ch; color = overLay.color; }
          if(isOutside && !this.showVideo) { ch = '\u00A0'; bgColor = `background-color:${this.voidColor};`; }
          html += `<span style="color:${color};${bgColor}">${ch}</span>`;
        }
        if(y<H-1) html += '<br/>';
      }
      return html;
    }

    isPointOnLandEnhanced(lat, lon){
      let landCount=0; const samples=4; const offset=0.05;
      for(let dy=-1; dy<=1; dy+=2){
        for(let dx=-1; dx<=1; dx+=2){
          const sLat=lat + dy*offset, sLon=lon + dx*offset;
          if(this.isPointOnLand(sLat,sLon)) landCount++;
        }
      }
      return landCount >= samples/2;
    }

    isPointOnLand(lat, lon){
      for(const points of Object.values(this.continents)){
        if(this.pointInPolygon(lat,lon,points)) return true;
      }
      return false;
    }

    pointInPolygon(lat, lon, poly){
      let inside=false;
      for(let i=0,j=poly.length-1;i<poly.length;j=i++){
        const [lat1,lon1]=poly[i], [lat2,lon2]=poly[j];
        if(((lat1>lat)!==(lat2>lat)) && (lon < (lon2-lon1)*(lat-lat1)/(lat2-lat1) + lon1)){
          inside=!inside;
        }
      }
      return inside;
    }

    lumToChar(L){
      const idx = Math.floor(Math.max(0,Math.min(1,L))*(this.luminanceRamp.length-1));
      return this.luminanceRamp[idx];
    }
  }

  const globe = new RandomGlobe();
  </script>
</body>
</html>